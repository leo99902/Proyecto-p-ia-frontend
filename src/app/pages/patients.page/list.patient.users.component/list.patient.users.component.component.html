<!-- Main Table Content -->
<div class="table-card">
    <!-- Global Message Container -->
    <div *ngIf="showMessage && !showEditPatientModal" class="global-message-container">
        <div [class]="'alert alert-' + messageType">
            {{ messageText }}
        </div>
    </div>

    <!-- Filter Section -->
    <fieldset class="filter-fieldset">
        <legend class="sr-only">Filtros de búsqueda</legend>
        <div class="filter-controls">
            <!-- Filter by Estado -->
            <div class="content-select">
                <select user="filtroEstado" [(ngModel)]="filtro.filtroEstado" (change)="applyFilter()" class="form-select" aria-label="Filtrar por estado">
                    <option value="" disabled selected hidden>Estado</option>
                    <option value="" selected>Todos los Estados</option>
                    <option value="activo">Usuario activo</option>
                    <option value="inactivo">Usuario inactivo</option>
                </select>
            </div>
    
            <!-- Search Input -->
            <div class="search-input-container">
                <input [(ngModel)]="filterSeekerValue" (keyup.enter)="applyFilter()" id="search" type="search" placeholder="Buscar Usuario..." autofocus required aria-label="Buscar por nombre, cédula o teléfono" />
                <button type="button" class="search-button" (click)="applyFilter()">
                    Buscar
                </button>
            </div>
        </div>
    </fieldset>

    <div class="table-responsive">
        <table class="table-custom">
            <thead>
                <tr>
                    <th>Nombre Completo</th>
                    <th>Cedula</th>
                    <th>Teléfono</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <!-- Loading indicator -->
                <tr *ngIf="isLoadingPatients">
                    <td colspan="5" style="text-align: center; padding: 20px;">Cargando pacientes...</td>
                </tr>
                <!-- Error message -->
                <tr *ngIf="!isLoadingPatients && patientsErrorMessage">
                    <td colspan="5" class="error-message">Error: {{ patientsErrorMessage }}</td>
                </tr>
                <!-- List of patients -->
                <tr *ngFor="let patient of patients">
                    <td data-label="Nombre">{{ patient.user }}</td>
                    <td data-label="Cédula">{{ patient.cedula || patient.cedula}}</td>
                    <td data-label="Teléfono">{{ patient.phone }}</td>
                    <td data-label="Estado">{{ patient.state }}</td>
                    <td data-label="Acciones" class="action-buttons">
                        <button class="btn btn-edit" (click)="openEditPatientModal(patient)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">
                                <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                                <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/>
                            </svg>
                            Editar
                        </button>
                        <button class="btn btn-view" (click)="openViewPatientModal(patient)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-fill" viewBox="0 0 16 16">
                                <path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/>
                                <path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/>
                            </svg>
                            Ver
                        </button>
                        <button class="btn btn-notes" (click)="openNotesModal(patient)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-journal-text" viewBox="0 0 16 16">
                                <path d="M5 10.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5zm0-2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0-2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0-2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
                                <path d="M3 0h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-1h1v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v1H1V2a2 2 0 0 1 2-2z"/>
                            </svg>
                            Notas
                        </button>
                    </td>
                </tr>
                <!-- Message if no patients -->
                <tr *ngIf="!isLoadingPatients && !patientsErrorMessage && patients.length === 0">
                    <td colspan="5" class="no-data-message">No hay pacientes registrados.</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="pagination-section">
        <nav class="pagination-nav" aria-label="Navegación de página">
            <ul class="pagination-list">
                <li class="pagination-item">
                    <button (click)="setpagedecrease()" class="pagination-link pagination-link--arrow" aria-label="Página anterior" [disabled]="pageValue <= 1">
                        &laquo; Regresar
                    </button>
                </li>
                <li class="pagination-info">
                    <span>Página {{pageValue}} de {{cantidadPages}}</span>
                    <span>Total registros: {{dashboardData.totalPatients}}</span>
                </li>
                <li class="pagination-item">
                    <button (click)="setpageincrease()" class="pagination-link pagination-link--arrow" aria-label="Página siguiente" [disabled]="pageValue >= cantidadPages">
                        Siguiente &raquo;
                    </button>
                </li>
            </ul>
        </nav>
    </div>
</div>

<!-- Modal para editar paciente -->
<div class="modal-backdrop" *ngIf="showEditPatientModal" (click)="closeEditPatientModal()">
    <div class="modal-content" (click)="$event.stopPropagation()" *ngIf="selectedPatientForEdit">
        <h3 class="modal-title">Editar Paciente</h3>

        <!-- Mensajes de alerta dentro del modal -->
        <div *ngIf="showMessage" class="global-message-container">
            <div [class]="'alert alert-' + messageType">
                {{ messageText }}
            </div>
        </div>

        <form (ngSubmit)="onEditPatientSubmit()" class="modal-form-grid">
            <div class="form-group">
                <label for="edit-user">Nombre Completo</label>
                <input id="edit-user" type="text" [(ngModel)]="selectedPatientForEdit.user" name="user" class="modal-input" required>
            </div>
            <div class="form-group">
                <label for="edit-email">Email</label>
                <input id="edit-email" type="email" [(ngModel)]="selectedPatientForEdit.email" name="email" class="modal-input" required>
            </div>
            <div class="form-group">
                <label for="edit-cedula">Cédula de Identidad (CI)</label>
                <input id="edit-cedula" type="number" [(ngModel)]="selectedPatientForEdit.cedula" name="cedula" class="modal-input" required>
            </div>
            <div class="form-group">
                <label for="edit-birthDate">Fecha de nacimiento</label>
                <input
          type="date"
          id="birthDate"
          name="birthDate"
          min="1900-01-01"
          max="2021-12-31"
          [(ngModel)]="selectedPatientForEdit.birthDate"
        />
            </div>
            <div class="form-group">
                <label for="edit-address">Dirección</label>
                <input id="edit-address" type="text" [(ngModel)]="selectedPatientForEdit.address" name="address" class="modal-input" required>
            </div>
            <div class="form-group">
                <label for="edit-occupation">Ocupación</label>
                <input id="edit-occupation" type="text" [(ngModel)]="selectedPatientForEdit.occupation" name="occupation" class="modal-input" required>
            </div>
            <div class="form-group">
                <label for="edit-phone">Teléfono</label>
                <input id="edit-phone" type="text" [(ngModel)]="selectedPatientForEdit.phone" name="phone" class="modal-input" required>
            </div>
            <div class="form-group">
                <label for="edit-state">Estado</label>
                <select id="edit-state" [(ngModel)]="selectedPatientForEdit.state" name="state" class="modal-input" required>
                    <option value="activo">activo</option>
                    <option value="inactivo">inactivo</option>
                </select>
            </div>
            <div class="form-group" style="grid-column: 1 / -1;">
                <label for="edit-infoDisease">Información de la Enfermedad</label>
                <textarea id="edit-infoDisease" [(ngModel)]="selectedPatientForEdit.infoDisease" name="infoDisease" rows="3" class="modal-input"></textarea>
            </div>
        </form>

        <div class="modal-actions">
            <button type="button" class="modal-btn-cancel" (click)="closeEditPatientModal()">Cancelar</button>
            <button type="submit" class="modal-btn-save" (click)="onEditPatientSubmit()">Guardar Cambios</button>
        </div>
    </div>
</div>

<!-- Modal para editar paciente -->
 <!-- Se encuentra en el componente components/modal.to.edit -->

<div class="modal-backdrop" *ngIf="showViewPatientModal" (click)="closeViewPatientModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <h3 class="modal-title">Detalles del Paciente</h3>
        <div class="modal-form-grid" *ngIf="viewedPatientDetails">
            <div class="form-group">
                <label>Nombre Completo</label>
                <input type="text" [value]="viewedPatientDetails.user" readonly class="modal-input readonly">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" [value]="viewedPatientDetails.email" readonly class="modal-input readonly">
            </div>
            <div class="form-group">
                <label>Cédula de Identidad (CI)</label>
                <input type="text" [value]="viewedPatientDetails.cedula || viewedPatientDetails.cedula" readonly class="modal-input readonly">
            </div>
            <div class="form-group">
                <label>Fecha de nacimiento</label>
                <input type="Date" [value]="viewedPatientDetails.birthDate" readonly class="modal-input readonly">
            </div>
            <div class="form-group">
                <label>Dirección</label>
                <input type="text" [value]="viewedPatientDetails.address" readonly class="modal-input readonly">
            </div>
            <div class="form-group">
                <label>Ocupación</label>
                <input type="text" [value]="viewedPatientDetails.occupation" readonly class="modal-input readonly">
            </div>
            <div class="form-group">
                <label>Teléfono</label>
                <input type="text" [value]="viewedPatientDetails.phone" readonly class="modal-input readonly">
            </div>
            <div class="form-group">
                <label>Consultas al Chatbot</label>
                <input type="text" [value]="isLoadingPromptsCount ? 'Cargando...' : (promptsCount ?? 'N/A')" readonly class="modal-input readonly">
            </div>
            
            <div class="form-group" *ngIf="viewedPatientDetails.disease">
                <label>Información de la Enfermedad</label>
                <textarea [value]="viewedPatientDetails.infoDisease || 'N/A'" rows="3" readonly class="modal-input readonly"></textarea>
            </div>
        </div>
        
        <div class="modal-actions">
            <button type="button" class="modal-btn-cancel" (click)="closeViewPatientModal()">Cerrar</button>
        </div>
    </div>
</div>

<!-- Modal para Notas del Paciente -->
<div class="modal-backdrop" *ngIf="showNotesModal" (click)="closeNotesModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <h3 class="modal-title">Notas del Paciente: {{ selectedPatientForNotes?.user }}</h3>

        <div class="notes-accordion">
            <!-- Indicador de carga para las notas -->
            <div *ngIf="isLoadingNotes" class="loading-notes">Cargando notas...</div>

            <!-- Lista de Notas Acordeón -->
            <div *ngIf="!isLoadingNotes && patientNotes.length > 0">
                <details *ngFor="let note of patientNotes" class="note-item">
                    <summary class="note-header">
                        <span class="note-title">{{ note.title }} - {{ note.createdAt | date:'short' }}</span>
                        <span class="note-toggle-icon"></span>
                    </summary>
                    <div class="note-content">
                        <p>{{ note.content }}</p>
                        <button class="btn btn-delete-note" (click)="openDeleteConfirmModal(note); $event.stopPropagation();">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                                <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
                            </svg>
                            Eliminar
                        </button>
                    </div>
                </details>
            </div>
            <p *ngIf="!isLoadingNotes && patientNotes.length === 0">No hay notas para este paciente.</p>
        </div>

        <!-- Formulario para añadir nueva nota -->
        <form (ngSubmit)="onSaveNote()" class="new-note-form">
            <h4 class="new-note-title">Añadir Nueva Nota</h4>
            <div class="form-group">
                <label for="note-title">Título</label>
                <input id="note-title" type="text" [(ngModel)]="newNote.title" name="title" class="modal-input" placeholder="Título de la nota" required>
            </div>
            <div class="form-group">
                <label for="patient-new-note">Contenido</label>
                <textarea id="patient-new-note" [(ngModel)]="newNote.content" name="content" rows="4" class="modal-input" placeholder="Escribir nueva nota aquí..." required></textarea>
            </div>
            <button type="submit" class="modal-btn-save" [disabled]="!newNote.title || !newNote.content">Guardar Nota</button>
        </form>
        
        <div class="modal-actions">
            <button type="button" class="modal-btn-cancel" (click)="closeNotesModal()">Cerrar</button>
        </div>
    </div>
</div>

<!-- Modal de Confirmación para Eliminar Nota -->
<div class="modal-backdrop" *ngIf="showDeleteNoteConfirmModal" (click)="closeDeleteConfirmModal()">
    <div class="modal-content confirmation-modal" (click)="$event.stopPropagation()">
        <h3 class="modal-title">Confirmar Eliminación</h3>
        <p>¿Seguro que quieres eliminar la nota "{{ noteToDelete?.title }}"?</p>
        <div class="modal-actions">
            <button type="button" class="modal-btn-cancel" (click)="closeDeleteConfirmModal()">
                Cancelar
            </button>
            <button type="button" class="modal-btn-delete" (click)="confirmDeleteNote()">
                Sí, eliminar
            </button>
        </div>
    </div>
</div>