<main class="dashboard-container">

    <div class="cards-grid">
        <!-- Single card for "Total Patients" -->
        <div class="card patient-card-full-width">
            <div class="card-header">
                <h3 class="card-title">Total de Pacientes</h3> 
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="card-icon" viewBox="0 0 16 16">
                  <path d="M1 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6"/>
                  <path d="M7.784 14.392A2.238 2.238 0 0 1 7 13c0-1.355.68-2.75 1.936-3.72A6.325 6.325 0 0 0 7 9c-4 0-5 3-5 4s1 1 1 1z"/>
                </svg>
            </div>
            <p class="card-value">{{ dashboardData.totalPatients }}</p>
            <p class="card-description">{{ dashboardData.patientsDescription }}</p>
        </div>
    </div>

    <!-- The "Monthly Report Gain" section has been removed -->

    <!-- SECTION: Patient Management (remains) -->
    <div class="patient-list-section">
        <h3 class="section-title">Listado de Pacientes</h3>
        <div class="table-container">
            <table class="patients-table">
                <thead>
                    <tr>
                        <th>Nombre Completo</th>
                        <th>CI</th>
                        <th>Teléfono</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Loading indicator -->
                    <tr *ngIf="isLoadingPatients">
                        <td colspan="5" style="text-align: center; padding: 20px;">Cargando pacientes...</td>
                    </tr>
                    <!-- Error message -->
                    <tr *ngIf="!isLoadingPatients && patientsErrorMessage">
                        <td colspan="5" class="error-message">{{ patientsErrorMessage }}</td>
                    </tr>
                    <!-- List of patients -->
                    <tr *ngFor="let patient of patients">
                        <td>{{ patient.name }}</td>
                        <td>{{ patient.cedula || patient.ci }}</td>
                        <td>{{ patient.phone }}</td>
                        <td>{{ patient.state }}</td>
                        <td class="action-buttons">
                            <!-- Button to open edit modal -->
                            <button class="edit-button" (click)="openEditPatientModal(patient)">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                                Editar
                            </button>
                            <!-- NEW Button to open view details modal -->
                            <button class="view-button" (click)="openViewPatientModal(patient)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/>
                                    <path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/>
                                </svg>
                                Ver
                            </button>
                        </td>
                    </tr>
                    <!-- Message if no patients -->
                    <tr *ngIf="!isLoadingPatients && !patientsErrorMessage && patients.length === 0">
                        <td colspan="5" class="no-data-message">No hay pacientes registrados.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal for editing patient (remains as is) -->
    <div class="modal-backdrop" *ngIf="showEditPatientModal" (click)="closeEditPatientModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <h3 class="modal-title">Editar Paciente</h3>
            <form (ngSubmit)="onEditPatientSubmit()">
                <div class="modal-form-grid">
                    <div class="form-group">
                        <label for="editName">Nombre Completo</label>
                        <input type="text" id="editName" name="name" [(ngModel)]="selectedPatientForEdit.name" required class="modal-input">
                    </div>
                    <div class="form-group">
                        <label for="editEmail">Email</label>
                        <input type="email" id="editEmail" name="email" [(ngModel)]="selectedPatientForEdit.email" required class="modal-input">
                    </div>
                    <div class="form-group">
                        <label for="editCi">Cédula de Identidad (CI)</label>
                        <input type="text" id="editCi" name="ci" [(ngModel)]="selectedPatientForEdit.ci" required class="modal-input" readonly>
                    </div>
                    <div class="form-group">
                        <label for="editAge">Edad</label>
                        <input type="number" id="editAge" name="age" [(ngModel)]="selectedPatientForEdit.age" required class="modal-input">
                    </div>
                    <div class="form-group">
                        <label for="editAddress">Dirección</label>
                        <input type="text" id="editAddress" name="address" [(ngModel)]="selectedPatientForEdit.address" class="modal-input">
                    </div>
                    <div class="form-group">
                        <label for="editOccupation">Ocupación</label>
                        <input type="text" id="editOccupation" name="occupation" [(ngModel)]="selectedPatientForEdit.occupation" class="modal-input">
                    </div>
                    <div class="form-group">
                        <label for="editPhone">Teléfono</label>
                        <input type="text" id="editPhone" name="phone" [(ngModel)]="selectedPatientForEdit.phone" class="modal-input">
                    </div>
                    
                    <div class="form-group form-group-checkbox">
                        <input type="checkbox" id="editDisease" name="disease" [(ngModel)]="selectedPatientForEdit.disease" class="modal-checkbox">
                        <label for="editDisease">¿Tiene enfermedad?</label>
                    </div>
                    
                    <div class="form-group" *ngIf="selectedPatientForEdit.disease">
                        <label for="editInfoDisease">Información de la Enfermedad</label>
                        <textarea id="editInfoDisease" name="infoDisease" [(ngModel)]="selectedPatientForEdit.infoDisease" rows="3" class="modal-input"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="editState">Estado</label>
                        <input type="text" id="editState" name="state" [(ngModel)]="selectedPatientForEdit.state" required class="modal-input">
                    </div>

                    <div class="form-group">
                        <label for="editPassword">Nueva Contraseña (opcional)</label>
                        <input type="password" id="editPassword" name="password" [(ngModel)]="selectedPatientForEdit.password" class="modal-input">
                        <small class="text-note">Dejar en blanco para mantener la contraseña actual.</small>
                    </div>

                    <div class="form-group">
                        <label for="editRole">Rol</label>
                        <input type="text" id="editRole" name="role" [(ngModel)]="selectedPatientForEdit.role" readonly class="modal-input readonly">
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="modal-btn-cancel" (click)="closeEditPatientModal()">Cancelar</button>
                    <button type="submit" class="modal-btn-save">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NEW Modal for Viewing Patient Details -->
    <div class="modal-backdrop" *ngIf="showViewPatientModal" (click)="closeViewPatientModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <h3 class="modal-title">Detalles del Paciente</h3>
            <div class="modal-form-grid" *ngIf="viewedPatientDetails">
                <div class="form-group">
                    <label>ID</label>
                    <input type="text" [value]="viewedPatientDetails.id" readonly class="modal-input readonly">
                </div>
                <div class="form-group">
                    <label>Nombre Completo</label>
                    <input type="text" [value]="viewedPatientDetails.name" readonly class="modal-input readonly">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" [value]="viewedPatientDetails.email" readonly class="modal-input readonly">
                </div>
                <div class="form-group">
                    <label>Cédula de Identidad (CI)</label>
                    <input type="text" [value]="viewedPatientDetails.cedula || viewedPatientDetails.ci" readonly class="modal-input readonly">
                </div>
                <div class="form-group">
                    <label>Edad</label>
                    <input type="number" [value]="viewedPatientDetails.age" readonly class="modal-input readonly">
                </div>
                <div class="form-group">
                    <label>Dirección</label>
                    <input type="text" [value]="viewedPatientDetails.address" readonly class="modal-input readonly">
                </div>
                <div class="form-group">
                    <label>Ocupación</label>
                    <input type="text" [value]="viewedPatientDetails.occupation" readonly class="modal-input readonly">
                </div>
                <div class="form-group">
                    <label>Teléfono</label>
                    <input type="text" [value]="viewedPatientDetails.phone" readonly class="modal-input readonly">
                </div>
                
                <div class="form-group form-group-checkbox-view">
                    <input type="checkbox" [checked]="viewedPatientDetails.disease" disabled class="modal-checkbox">
                    <label>¿Tiene enfermedad?</label>
                </div>
                
                <div class="form-group" *ngIf="viewedPatientDetails.disease">
                    <label>Información de la Enfermedad</label>
                    <textarea [value]="viewedPatientDetails.infoDisease || 'N/A'" rows="3" readonly class="modal-input readonly"></textarea>
                </div>

                <div class="form-group">
                    <label>Estado</label>
                    <input type="text" [value]="viewedPatientDetails.state" readonly class="modal-input readonly">
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="modal-btn-cancel" (click)="closeViewPatientModal()">Cerrar</button>
            </div>
        </div>
    </div>
</main>
